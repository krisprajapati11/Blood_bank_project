<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blood Donation Management</title>
    <link rel="stylesheet" href="style5.css">
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    <style>
        .scrollable-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
        }

        .success-msg {
            color: green;
            font-weight: bold;
        }

        .home-btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            display: block;
            width: 100%;
            text-align: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <button id="find-blood-centers">Find Nearby Blood Centers</button>
    <div id="centers-container"></div>

    <!-- Modal for Blood Stock -->
    <div id="blood-stock-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2 id="modal-title"></h2>
            <div id="stock-container" class="scrollable-container"></div>
        </div>
    </div>

    <script>
        let bloodCenters = [
            { 
                name: "Apollo Hospital", 
                address: "123 Main Street, City", 
                phone: "9876543210", 
                latitude: 23.0225, 
                longitude: 72.5714, 
                stock: { "A+": 10, "A-": 5, "B+": 8, "B-": 4, "O+": 12, "O-": 8, "AB+": 7, "AB-": 3 }
            },
            { 
                name: "Prathama Blood Centre", 
                address: "456 Health Ave, City", 
                phone: "9876543220", 
                latitude: 23.0245, 
                longitude: 72.5716, 
                stock: { "A+": 15, "A-": 7, "B+": 10, "B-": 5, "O+": 18, "O-": 8, "AB+": 9, "AB-": 4 }
            }
        ];

        let donors = [
            { name: "Darshil Shah", bloodType: "A+", phone: "9624051692", location: "Mansa" },
            { name: "Harshil Shah", bloodType: "O-", phone: "7016534432", location: "Randheja" },
            { name: "Fenil Prajapati", bloodType: "B+", phone: "9904189728", location: "LDRP" },
            { name: "Kris Prajapati", bloodType: "AB+", phone: "7862894847", location: "Charada" }
        ];

        document.getElementById("find-blood-centers").addEventListener("click", function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLon = position.coords.longitude;

                    let nearbyCenters = bloodCenters
                        .map(center => ({
                            ...center,
                            distance: getDistance(userLat, userLon, center.latitude, center.longitude)
                        }))
                        .filter(center => center.distance <= 50)
                        .sort((a, b) => a.distance - b.distance);

                    displayCenters(nearbyCenters);
                }, () => {
                    alert("Unable to retrieve location.");
                });
            } else {
                alert("Geolocation not supported.");
            }
        });

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            return R * 2 * Math.atan2(Math.sqrt(Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) * Math.sin(dLon / 2) ** 2), Math.sqrt(1 - Math.sin(dLat / 2) ** 2));
        }

        function displayCenters(centers) {
            const container = document.getElementById("centers-container");
            container.innerHTML = centers.length ? "" : "<p>No nearby centers found within 50 km.</p>";

            centers.forEach(center => {
                const card = document.createElement("div");
                card.classList.add("center-card");
                card.innerHTML = `
                    <h3>${center.name}</h3>
                    <p><i class="fas fa-map-marker-alt"></i> ${center.address}</p>
                    <p><i class="fas fa-phone"></i> <a href="tel:${center.phone}">${center.phone}</a></p>
                    <button class="check-stock-btn" onclick='showBloodStock(${JSON.stringify(center)})'>Check Stock</button>
                `;
                container.appendChild(card);
            });
        }

        function showBloodStock(center) {
            const stockContainer = document.getElementById("stock-container");
            stockContainer.innerHTML = "";

            Object.entries(center.stock).forEach(([type, qty]) => {
                let btn = document.createElement("button");
                btn.classList.add("blood-stock-btn");
                btn.textContent = `${type}: ${qty} units`;
                btn.onclick = () => selectBloodType(center, type, qty);
                stockContainer.appendChild(btn);
            });

            stockContainer.innerHTML += `
                <button class="request-blood-btn" onclick="requestBlood('${center.name}')">Request Blood</button>
                <p id="request-message"></p>
            `;

            document.getElementById("modal-title").textContent = `Available Blood Stock - ${center.name}`;
            document.getElementById("blood-stock-modal").style.display = "flex";
            document.querySelector(".close-btn").onclick = closeModal;
        }

        function requestBlood(centerName) {
            let center = bloodCenters.find(c => c.name === centerName);
            const requestMessage = document.getElementById("request-message");

            requestMessage.innerHTML = `
                <p class="success-msg">âœ… Your blood request has been approved.</p>
                <button class="home-btn" onclick="window.location.href='index.html'">Back to Home</button>
            `;

            setTimeout(() => {
                document.getElementById("blood-stock-modal").style.display = "none";
            }, 2000);
        }

        function closeModal() {
            document.getElementById("blood-stock-modal").style.display = "none";
        }
    </script>

</body>
</html>
